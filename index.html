<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Interactive PPM Dashboard with Drill-Down</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js">

</script>
<style>
.group-btn.active {
  background: #2563eb;
  color: #fff;
  font-weight: 600;
  box-shadow: 0 4px 10px rgba(37,99,235,0.4);
}

.group-btn.active {
  background: #2563eb;
  color: white;
}

.scheduled {
  background-color: #d0e7ff; /* light blue */
}

body{font-family:Arial,sans-serif;background:#f4f6f9;margin:20px}
h2{margin:12px 0}
.dashboard{display:flex;gap:15px;flex-wrap:wrap;margin-bottom:15px}
.card{background:#fff;padding:14px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);min-width:180px;text-align:center}
.card span{font-size:24px;font-weight:bold;display:block}
.alert{border:2px solid #e74c3c}
.filters,.add-form{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
input,select,button{padding:7px;border-radius:6px;border:1px solid #ccc}
button{cursor:pointer}
.add-form button{background:#27ae60;color:#fff;border:none}
.group-btn{background:#34495e;color:#fff;border:none;padding:6px 12px;border-radius:6px}
table{width:100%;border-collapse:collapse;background:#fff;font-size:13px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#eee}
.missed{background:#ffd6d6}
canvas{max-height:320px}
#drillModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center}
#drillModal div{background:#fff;padding:20px;border-radius:8px;max-width:90%;max-height:90%;overflow:auto;position:relative}
#closeModal{position:absolute;top:10px;right:10px;padding:6px 10px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer}

/* ===== 2x2 Chart Grid Layout ===== */
/* ===== Group PPM small horizontal charts ===== */
/* ===== Group PPM Overview ONLY ===== */
/* ===== Analytics charts (OLD layout restored) ===== */

.chart-grid{
  display:grid;
  grid-template-columns: repeat(2, 1fr);
  gap:15px;
  margin-bottom:20px;
}

.chart-grid .card{
  min-height:360px;
}

#groupDashboard{
  display:flex;
  gap:15px;
  flex-wrap:wrap;
  margin-bottom:20px;
}

#groupDashboard .card{
  width:220px;
  min-height:260px;
  display:flex;
  flex-direction:column;
  align-items:center;
}

#groupDashboard canvas{
  max-width:180px !important;
  max-height:180px !important;
}


/* ===== Full width chart ===== */
.full-width{
  width:100%;
  min-height:420px;
}

.full-width canvas{
  width:100% !important;
  height:340px !important;
}


/* ===== Dashboard Header (Title + Logo) ===== */
.dashboard-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.dashboard-header h2{
  margin: 0;
}

.header-logo{
  height: 25px;   /* adjust if needed */
  width: auto;
}


</style>
</head>
<body>

<div class="dashboard-header">
  <h2>Overall PPM Overview</h2>
  
  <!-- Right-side container for logout + logo -->
  <div style="display:flex; align-items:center; gap:10px;">
    <button id="logoutBtn" style="
        padding:6px 12px;
        background:#e74c3c;
        color:white;
        border:none;
        border-radius:6px;
        cursor:pointer;
    ">Logout</button>
    <img src="Logo.GIF" alt="Company Logo" class="header-logo">
  </div>
</div>

<div class="dashboard" id="kpiDashboard"></div>

<h2>Group PPM Overview</h2>
<div class="chart-grid" id="groupDashboard"></div>


<h2>Add / Edit PPM Contract</h2>
<div class="add-form">
  <select id="addGroup">
    <option value="">Group</option>
    <option>Geely</option>
    <option>BMW</option>
    <option>Pitstop</option>
    <option>Budget</option>
  </select>
  <input id="addLocation" placeholder="Location">
  <input id="addService" placeholder="Service">
  <input id="addVendor" placeholder="Vendor">
  <input type="date" id="addStart">
  <input type="date" id="addEnd">
  <input type="number" id="addInterval" placeholder="Interval Days">
  <button id="addBtn">Add</button>
</div>

<h2>Search</h2>
<div class="filters">
  <input id="searchLocation" placeholder="Location">
  <input id="searchService" placeholder="Service">
  <input id="searchVendor" placeholder="Vendor">
  <select id="searchStatus">
  <option value="all">All</option>
  <option value="Scheduled">Scheduled</option>
  <option value="Missed">Missed</option>
  <option value="Completed">Completed</option>
</select>


  <button id="searchBtn">Search</button>
  <button id="resetBtn">Reset</button>
</div>

<h2>Location Groups</h2>
<div class="filters">
  <button class="group-btn" data-group="Geely">Geely</button>
  <button class="group-btn" data-group="BMW">BMW</button>
  <button class="group-btn" data-group="Pitstop">Pitstop</button>
  <button class="group-btn" data-group="Budget">Budget</button>
  <button id="showAllBtn">Show All</button>

<button id="collapseBtn">Collapse Rows</button>

</div>


<table id="ppmTable">
<thead>
<tr>
  <th>Group</th><th>Service</th><th>Location</th><th>Vendor</th>
  <th>Start</th><th>End</th><th>Next Due</th><th>Missed</th>
  <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th>
  <th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
  <th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2>Analytics</h2>


<div class="chart-grid">
  <div class="card">
    <h3 style="text-align:center;margin-bottom:10px;">Facility Wise PPM Overview</h3>
    <canvas id="groupStatusChart"></canvas>
  </div>
  <div class="card">
    <h3 style="text-align:center;margin-bottom:10px;">Service Wise PPM Overview</h3>
    <canvas id="monthlyTrendChart"></canvas>
  </div>
  <div class="card">
    <h3 style="text-align:center;margin-bottom:10px;">Vendor Wise PPM Overview</h3>
    <canvas id="vendorChart"></canvas>
  </div>
  <div class="card">
    <h3 style="text-align:center;margin-bottom:10px;">Completion Wise PPM Overview</h3>
    <canvas id="complianceGauge"></canvas>
  </div>
</div>

<div class="card full-width">
  <h3>Scheduled PPM – Month Wise (All Groups & Locations)</h3>

  <!-- ✅ Buttons go directly under heading -->
  <div style="margin:10px 0;">
    <select id="scheduledGroupFilter">
      <option value="">Select Group</option>
      <option>Geely</option>
      <option>BMW</option>
      <option>Pitstop</option>
      <option>Budget</option>
    </select>

    <select id="scheduledLocationFilter">
      <option value="">Select Location</option>
    </select>

    <button id="scheduledResetBtn">Show All</button>
  </div>

  <canvas id="scheduledMonthChart"></canvas>
</div>




<!-- Drill-down Modal -->
<div id="drillModal">
  <div>
    <button id="closeModal">Close</button>
    <h3 id="modalTitle">Details</h3>
    <table id="modalTable" style="width:100%;border-collapse:collapse;margin-top:10px;">
      <thead>
        <tr>
          <th>Group</th><th>Service</th><th>Location</th><th>Vendor</th>
          <th>Start</th><th>End</th><th>Next Due</th><th>Missed</th>
          <th>Jan</th><th>Feb</th><th>Mar</th><th>Apr</th><th>May</th><th>Jun</th>
          <th>Jul</th><th>Aug</th><th>Sep</th><th>Oct</th><th>Nov</th><th>Dec</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>




<script>
let activeGroup = "ALL";
let isTableCollapsed = false;

function setActiveGroupButton(group) {
  document.querySelectorAll(".group-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.group === group);
  });
}

const STORAGE_KEY="ppm:v70";
const MONTHS=["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"];
const GROUPS=["Geely","BMW","Pitstop","Budget"];
const OVERDUE_ALERT_LIMIT=5;

let data=JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]");
let editIndex=null, charts={};
let modalData=[];

// Global month range for all charts and tables
function updateGlobalMonths() {
    if (!data.length) return [];
    const minDate = new Date(Math.min(...data.map(r => new Date(r.start))));
    const maxDate = new Date(Math.max(...data.map(r => new Date(r.end))));
    return getMonthRange(minDate, maxDate);
}


let globalMonths = updateGlobalMonths();


// --- Save to localStorage ---
const save=()=>localStorage.setItem(STORAGE_KEY,JSON.stringify(data));

// --- Helper functions ---
function getNextDue(r){
  let d=new Date(r.start), today=new Date();
  while(d<=today) d.setDate(d.getDate()+r.intervalDays);
  return d;
}

function getMissed(r){
  let due=new Date(r.start), today=new Date(), end=new Date(r.end), missed=[];
  while(due<=today && due<=end){
    const key = `${due.getFullYear()}-${due.getMonth()}`;
    if(!r.months?.[key]) missed.push({date:new Date(due), key});
    due.setDate(due.getDate()+r.intervalDays);
  }
  return missed;
}

function getScheduled(r){
  const today = new Date();
  const scheduled = [];
  let due = new Date(r.start);
  const end = new Date(r.end);
  while(due <= end){
    const key = `${due.getFullYear()}-${due.getMonth()}`;
    if(!r.months?.[key] && due >= today) scheduled.push({date:new Date(due), key});
    due.setDate(due.getDate() + r.intervalDays);
  }
  return scheduled;
}

/* ✅ STEP 1 GOES HERE */
const stackedBarLabels = {
  id: 'stackedBarLabels',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;

    chart.data.datasets.forEach((dataset, datasetIndex) => {
      const meta = chart.getDatasetMeta(datasetIndex);
      meta.data.forEach((bar, index) => {
        const value = dataset.data[index];
        if (!value) return;

        const label = `${dataset.label}: ${value}`;

        ctx.save();
        ctx.fillStyle = "#000";
        ctx.font = "bold 11px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        const x = bar.x;
        const y = bar.y + (bar.height / 2);

        ctx.fillText(label, x, y);
        ctx.restore();
      });
    });
  }
};
function getStatus(r){
  const today=new Date();
  if(today>new Date(r.end)) return "Out";
  const missed=getMissed(r);
  if(missed.length===0) return "Completed";
  const hasOverdue=missed.some(x=>x.date<=today);
  if(hasOverdue) return "Overdue";
  return "Scheduled";
}

function getMonthRange(startDate,endDate){
  const start = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
  const end = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
  const months = [];
  let current = new Date(start);

  while(current <= end){
    months.push({month: current.getMonth(), year: current.getFullYear()});
    current.setMonth(current.getMonth() + 1);
  }
  return months;
}


function countCompleted(r){
  return Object.entries(r.months || {}).filter(([k,v])=>{
    if(!v) return false;
    const [y,m] = k.split("-").map(Number);
    const d = new Date(y, m, 15);
    return d >= new Date(r.start) && d <= new Date(r.end);
  }).length;
}

function countMissed(r, allMonths){
  const today = new Date();
  const currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);

  return allMonths.filter(m=>{
    const key = `${m.year}-${m.month}`;
    const monthDate = new Date(m.year, m.month, 1);

    // must be inside contract
    if(monthDate < new Date(r.start) || monthDate > new Date(r.end)) return false;

    // must be before current month
    if(monthDate >= currentMonth) return false;

    // must NOT be completed
    if(r.months?.[key]) return false;

    return true;
  }).length;
}

function countScheduled(r, allMonths){
  const today = new Date();
  return allMonths.filter(m=>{
    const key = `${m.year}-${m.month}`;
    const d = new Date(m.year, m.month, 15);
    return (
      d >= today &&
      d >= new Date(r.start) &&
      d <= new Date(r.end) &&
      !r.months?.[key]
    );
  }).length;
}

// --- KPIs ---
function renderKPIs(){
  let total = 0;
  let missed = 0;
  let completed = 0;
  let scheduled = 0;

  data.forEach(r=>{
    if(getStatus(r)!=="Out"){
      const cycles = Math.ceil(
        (new Date(r.end)-new Date(r.start)) /
        (r.intervalDays*24*60*60*1000)
      );
      total += cycles;
      missed += getMissed(r).length;
      completed += Object.values(r.months || {}).filter(v => v).length;
      scheduled += getScheduled(r).length;
    }
  });

  const compliance = total
    ? Math.round(((total - missed) / total) * 100)
    : 0;

  kpiDashboard.innerHTML = `
    <div class="card">
      Total PPM<span>${total}</span>
    </div>

    <div class="card">
      Missed<span>${missed}</span>
    </div>

    <div class="card">
      Completed<span>${completed}</span>
    </div>

    <div class="card">
      Scheduled<span>${scheduled}</span>
    </div>

    <div class="card">
      Compliance %<span>${compliance}%</span>
    </div>
  `;
}


// --- Group Dashboard ---
function renderGroupDashboard(){
  groupDashboard.innerHTML = "";

  GROUPS.forEach(group => {
    const rows = data.filter(r => r.group === group && getStatus(r) !== "Out");

    let total = 0;
    let completed = 0;
    let scheduled = 0;
    let missed = 0;

    rows.forEach(r => {
      const cycles = Math.ceil(
        (new Date(r.end) - new Date(r.start)) /
        (r.intervalDays * 24 * 60 * 60 * 1000)
      );
      total += cycles;
      completed += Object.values(r.months || {}).filter(v => v).length;
      scheduled += getScheduled(r).length;
      missed += getMissed(r).length;
    });

    // Create container
    const wrapper = document.createElement("div");
    wrapper.className = "card";
    wrapper.innerHTML = `
      <h3 style="text-align:center;margin-bottom:10px">${group}</h3>
      <canvas id="groupChart_${group}"></canvas>
    `;
    groupDashboard.appendChild(wrapper);

    // Draw circular graph
    new Chart(document.getElementById(`groupChart_${group}`), {
      type: "doughnut",
      data: {
        labels: [
          `Completed (${completed})`,
          `Scheduled (${scheduled})`,
          `Missed (${missed})`,
          `Total (${total})`
        ],
        datasets: [{
          data: [completed, scheduled, missed, total],
          backgroundColor: [
            "#27ae60", // completed
            "#3498db", // scheduled
            "#e74c3c", // missed
            "#95a5a6"  // total
          ]
        }]
      },
      options: {
      
        cutout: "0%",
        plugins: {
          legend: {
            position: "bottom"
          }
        }
      }
    });
  });
}



// --- Render Table ---
function renderTable(rows=data){
  if(rows.length===0) return ppmTable.querySelector("tbody").innerHTML="";

  const minDate = new Date(Math.min(...rows.map(r=>new Date(r.start))));
  const maxDate = new Date(Math.max(...rows.map(r=>new Date(r.end))));
  const allMonths = getMonthRange(minDate,maxDate);

  // Table header
  const fixedCols = `<tr>
    <th>Group</th><th>Service</th><th>Location</th><th>Vendor</th>
    <th>Start</th><th>End</th><th>Next Due</th><th>Missed</th>`;
  const monthCols = allMonths.map(m=>`<th>${MONTHS[m.month].toUpperCase()} ${m.year}</th>`).join("");
  const actionCol = "<th>Action</th>";
  ppmTable.querySelector("thead").innerHTML = fixedCols+monthCols+actionCol;

  // Table body
  const tbody = ppmTable.querySelector("tbody");
  tbody.innerHTML="";
  rows.forEach((r,i)=>{
    const missed=getMissed(r), scheduled=getScheduled(r);
    const monthCells = allMonths.map(m=>{
      const key=`${m.year}-${m.month}`;
      const isMissed = missed.some(x=>x.key===key);
      const isScheduled = scheduled.some(x=>x.key===key);
      const checked = r.months?.[key]?"checked":"";
      return `<td class="${isMissed?'missed':isScheduled?'scheduled':''}">
        <input type="checkbox" data-i="${i}" data-m="${key}" ${checked}></td>`;
    }).join("");

    tbody.insertAdjacentHTML("beforeend",`
      <tr class="ppm-row" style="display:${isTableCollapsed ? "none" : ""}">
        <td>${r.group}</td><td>${r.service}</td><td>${r.location}</td><td>${r.vendor}</td>
        <td>${r.start}</td><td>${r.end}</td><td>${getNextDue(r).toISOString().slice(0,10)}</td>
        <td>${missed.length}</td>
        ${monthCells}
        <td><button data-edit="${i}">Edit</button><button data-del="${i}">Delete</button></td>
      </tr>`);
  });

  renderKPIs(); renderGroupDashboard(); renderCharts(allMonths, rows);
}

// --- Drill-down Modal ---
function openModal(title, filteredData){
    modalData = filteredData;
    drillModal.style.display = "flex";
    modalTitle.textContent = title;
    const tbody = modalTable.querySelector("tbody");
    tbody.innerHTML = "";

    // Calculate all months for modal table
    const allStarts = filteredData.map(r => new Date(r.start));
    const allEnds = filteredData.map(r => new Date(r.end));
    const minDate = new Date(Math.min(...allStarts));
    const maxDate = new Date(Math.max(...allEnds));
    const allMonths = getMonthRange(minDate, maxDate);

    // Generate table rows
    filteredData.forEach((r, i) => {
        const missed = getMissed(r);
        const scheduled = getScheduled(r);

        const monthCells = allMonths.map(m => {
            const key = `${m.year}-${m.month}`;
            const isMissed = missed.some(x => x.key === key);
            const isScheduled = scheduled.some(x => x.key === key);
            const checked = r.months?.[key] ? "checked" : "";
            return `<td class="${isMissed ? 'missed' : isScheduled ? 'scheduled' : ''}">
                <input type="checkbox" data-i="${i}" data-m="${key}" ${checked}></td>`;
        }).join("");

        tbody.insertAdjacentHTML("beforeend",`
  <tr class="ppm-row">

                <td>${r.group}</td><td>${r.service}</td><td>${r.location}</td><td>${r.vendor}</td>
                <td>${r.start}</td><td>${r.end}</td><td>${getNextDue(r).toISOString().slice(0,10)}</td>
                <td>${missed.length}</td>
                ${monthCells}
                <td><button data-edit="${i}">Edit</button><button data-del="${i}">Delete</button></td>
            </tr>
        `);
    });
}

closeModal.onclick=()=>{drillModal.style.display="none";};

// --- Table Events ---
ppmTable.onclick=e=>{
  if(e.target.dataset.del){data.splice(e.target.dataset.del,1); save(); renderTable();}
  if(e.target.dataset.edit){
    editIndex=e.target.dataset.edit;
    const r=data[editIndex];
    addGroup.value=r.group; addLocation.value=r.location; addService.value=r.service;
    addVendor.value=r.vendor; addStart.value=r.start; addEnd.value=r.end; addInterval.value=r.intervalDays;
    addBtn.textContent="Update";
  }
};

ppmTable.onchange=e=>{
  if(e.target.type==="checkbox"){
    const i=e.target.dataset.i;
    data[i].months=data[i].months||{};
    data[i].months[e.target.dataset.m]=e.target.checked;
    save(); renderTable();
  }
};

modalTable.onchange=e=>{
  if(e.target.type==="checkbox"){
    const i=e.target.dataset.i;
    modalData[i].months=modalData[i].months||{};
    modalData[i].months[e.target.dataset.m]=e.target.checked;
    save(); renderTable();
  }
};

// --- Add / Edit ---
addBtn.onclick=()=>{
  if(!addGroup.value||!addLocation.value||!addService.value||!addVendor.value||!addStart.value||!addEnd.value||!addInterval.value) return alert("Fill all fields");
  const obj={group:addGroup.value,location:addLocation.value,service:addService.value,vendor:addVendor.value,start:addStart.value,end:addEnd.value,intervalDays:+addInterval.value,months:{}};
  if(editIndex!==null){data[editIndex]={...data[editIndex],...obj}; editIndex=null; addBtn.textContent="Add";}
  else data.push(obj);
  save(); renderTable();
  addGroup.value=addLocation.value=addService.value=addVendor.value=addStart.value=addEnd.value=addInterval.value="";
};

// --- Search / Filters ---
searchBtn.onclick = () => {
  const filtered = data.filter(r => {
    // Text filters
    const loc = !searchLocation.value || r.location.toLowerCase().includes(searchLocation.value.toLowerCase());
    const serv = !searchService.value || r.service.toLowerCase().includes(searchService.value.toLowerCase());
    const vend = !searchVendor.value || r.vendor.toLowerCase().includes(searchVendor.value.toLowerCase());

    // Status filter
    const status = searchStatus.value;
    let statusMatch = true;
    if(status === "Scheduled") statusMatch = getScheduled(r).length > 0;
    else if(status === "Missed") statusMatch = getMissed(r).length > 0;
    else if(status === "Completed") statusMatch = getMissed(r).length === 0 && Object.values(r.months||{}).filter(v=>v).length > 0;

    return loc && serv && vend && (status==="all" || statusMatch);
  });

  renderTable(filtered);
};


resetBtn.onclick=()=>{searchLocation.value=searchService.value=searchVendor.value=""; searchStatus.value="all"; renderTable();};




// --- Charts ---
function renderCharts(allMonths, filteredData = data) {

const groupStatusCtx = document.getElementById("groupStatusChart");
  const monthlyTrendCtx = document.getElementById("monthlyTrendChart");
  const vendorCtx = document.getElementById("vendorChart");
  const complianceCtx = document.getElementById("complianceGauge");

  if (!groupStatusCtx || !monthlyTrendCtx || !vendorCtx || !complianceCtx) {
    console.warn("Chart canvas missing");
    return;
  }
    // Destroy old charts
    Object.values(charts).forEach(c => c.destroy?.());

    // --- Group Status Chart ---
    const groupCompleted = GROUPS.map(g =>
        filteredData.filter(r => r.group === g)
            .reduce((a, r) => a + Object.values(r.months || {}).filter(v => v).length, 0)
    );

    const groupMissed = GROUPS.map(g =>
        filteredData.filter(r => r.group === g)
            .reduce((a, r) => a + getMissed(r).length, 0)
    );

    const groupScheduled = GROUPS.map(g =>
        filteredData.filter(r => r.group === g)
            .reduce((a, r) => a + getScheduled(r).length, 0)
    );

    charts.groupStatusChart = new Chart(groupStatusCtx, {
        type: 'bar',
        data: { labels: GROUPS, datasets: [
            { label: "Completed", data: groupCompleted, backgroundColor: "#27ae60" },
            { label: "Scheduled", data: groupScheduled, backgroundColor: "#3498db" },
            { label: "Missed", data: groupMissed, backgroundColor: "#e67e22" }
        ]},
        options: { 
            plugins: { legend: { display: true } },
            onClick: (evt, items) => {
                if(items.length > 0){
                    openModal(`Group: ${GROUPS[items[0].index]}`, data.filter(r => r.group === GROUPS[items[0].index]));
                }
            }
        }
    });

    
    // --- Service-wise Status Chart ---
const serviceMap = {};
filteredData.forEach(r => {
    if (!serviceMap[r.service]) serviceMap[r.service] = { completed: 0, scheduled: 0, missed: 0 };
    serviceMap[r.service].completed += Object.values(r.months || {}).filter(v => v).length;
    serviceMap[r.service].scheduled += getScheduled(r).length;
    serviceMap[r.service].missed += getMissed(r).length;
});

const serviceLabels = Object.keys(serviceMap);

charts.monthlyTrendChart = new Chart(monthlyTrendChart, {
    type: 'bar',
    data: {
        labels: serviceLabels,
        datasets: [
            { label: "Completed", data: serviceLabels.map(s => serviceMap[s].completed), backgroundColor: "#27ae60" },
            { label: "Scheduled", data: serviceLabels.map(s => serviceMap[s].scheduled), backgroundColor: "#3498db" },
            { label: "Missed", data: serviceLabels.map(s => serviceMap[s].missed), backgroundColor: "#e74c3c" }
        ]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
        onClick: (evt, items) => {
            if(items.length > 0){
                const service = serviceLabels[items[0].index];
                openModal(`Service: ${service}`, data.filter(r => r.service === service));
            }
        }
    },
    plugins: [stackedBarLabels]
});

    // --- Vendor Chart ---
    const vendorMap = {};
    filteredData.forEach(r => {
        if (!vendorMap[r.vendor]) vendorMap[r.vendor] = { completed: 0, scheduled: 0, missed: 0 };
        vendorMap[r.vendor].completed += Object.values(r.months || {}).filter(v => v).length;
        vendorMap[r.vendor].scheduled += getScheduled(r).length;
        vendorMap[r.vendor].missed += getMissed(r).length;
    });

    const vendorLabels = Object.keys(vendorMap);

    charts.vendorChart = new Chart(vendorChart, {
        type: 'bar',
        data: {
            labels: vendorLabels,
            datasets: [
                { label: "Completed", data: vendorLabels.map(v => vendorMap[v].completed), backgroundColor: "#27ae60" },
                { label: "Scheduled", data: vendorLabels.map(v => vendorMap[v].scheduled), backgroundColor: "#f1c40f" },
                { label: "Missed", data: vendorLabels.map(v => vendorMap[v].missed), backgroundColor: "#e67e22" }
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
            onClick: (evt, items) => {
                if(items.length > 0){
                    const vendor = vendorLabels[items[0].index];
                    openModal(`Vendor: ${vendor}`, data.filter(r => r.vendor === vendor));
                }
            }
        },
        plugins: [stackedBarLabels]
    });

    // --- Compliance Gauge ---
   let totalCompleted = 0, totalMissed = 0, totalScheduled = 0;

filteredData.forEach(r => {
    totalCompleted += Object.values(r.months || {}).filter(v => v).length;
    totalMissed += getMissed(r).length;
    totalScheduled += getScheduled(r).length;
});


    // --- Completion Wise PPM Overview Chart ---
charts.complianceGauge = new Chart(complianceGauge, {
    type: 'doughnut',
    data: {
        labels: ["Completed", "Scheduled", "Missed"],
        datasets: [{
            data: [
                filteredData.reduce((sum, r) => sum + Object.values(r.months || {}).filter(v => v).length, 0),
                filteredData.reduce((sum, r) => sum + countScheduled(r, allMonths), 0),
                filteredData.reduce((sum, r) => sum + countMissed(r, allMonths), 0)
            ],
            backgroundColor: ["#27ae60", "#3498db", "#e74c3c"]
        }]
    },
    options: {
        rotation: -90,
        circumference: 180,
        plugins: { legend: { display: true, position: 'bottom' } },
        onClick: (evt, items) => {
            if(items.length === 0) return;

            const label = items[0].chart.data.labels[items[0].index];
            let filteredRows = [];

            if(label === "Completed") {
                filteredRows = filteredData.filter(r => Object.values(r.months||{}).filter(v => v).length > 0);
            } else if(label === "Scheduled") {
                filteredRows = filteredData.filter(r => countScheduled(r, allMonths) > 0);
            } else if(label === "Missed") {
                filteredRows = filteredData.filter(r => countMissed(r, allMonths) > 0);
            }

            if(filteredRows.length > 0) {
                openModal(`${label} PPM`, filteredRows);
            }
        }
    }
});


}
const collapseBtn = document.getElementById("collapseBtn");

if (collapseBtn) {
  collapseBtn.addEventListener("click", () => {
    isTableCollapsed = !isTableCollapsed;

    document.querySelectorAll(".ppm-row").forEach(row => {
      row.style.display = isTableCollapsed ? "none" : "";
    });

    collapseBtn.textContent = isTableCollapsed
      ? "Expand Rows"
      : "Collapse Rows";
  });
}

// --- Initial render ---
renderTable();

const allMonths = globalMonths;




// ===== GROUP BUTTON HIGHLIGHT LOGIC =====
const groupButtons = document.querySelectorAll(".group-btn");
const showAllBtn = document.getElementById("showAllBtn");

// Group buttons click
groupButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    activeGroup = btn.dataset.group;

    // Remove highlight from all buttons
    groupButtons.forEach(b => b.classList.remove("active"));

    // Highlight clicked button
    btn.classList.add("active");

    // Filter table and charts by selected group
    const filtered = data.filter(r => r.group === activeGroup);
    renderTable(filtered);
    renderCharts(globalMonths, filtered);
  });
});

// Show All button click
if (showAllBtn) {
  showAllBtn.addEventListener("click", () => {
    activeGroup = "ALL";

    // Remove all highlights
    groupButtons.forEach(b => b.classList.remove("active"));

    // Show all data
    renderTable(data);
    renderCharts(globalMonths, data);
  });
}

let scheduledChart; // store chart instance globally
let scheduledGroupFilter = "";
let scheduledLocationFilter = "";

let scheduledMonthChartInstance = null;

function renderScheduledMonthChart(filteredData = data, groupFilter = "", locationFilter = "") {
    const monthsRange = updateGlobalMonths(); // get full months range from data
    const monthLabels = monthsRange.map(m => `${MONTHS[m.month].toUpperCase()} ${m.year}`);
    const monthCounts = Array(monthLabels.length).fill(0);

    filteredData.forEach(r => {
        if (getStatus(r) === "Out") return;

        // Apply group filter
        if (groupFilter && r.group !== groupFilter) return;
        // Apply location filter
        if (locationFilter && r.location !== locationFilter) return;

        const scheduled = getScheduled(r);
        scheduled.forEach(s => {
            // Find index in monthsRange
            const idx = monthsRange.findIndex(m => m.year === s.date.getFullYear() && m.month === s.date.getMonth());
            if (idx !== -1) monthCounts[idx]++;
        });
    });

    const ctx = document.getElementById("scheduledMonthChart");

    // Destroy old chart if exists
    if (scheduledMonthChartInstance) scheduledMonthChartInstance.destroy();

    scheduledMonthChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
            labels: monthLabels,
            datasets: [{
                label: "Scheduled PPM",
                data: monthCounts,
                backgroundColor: "#3498db"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: "Scheduled PPM Count" } },
                x: { title: { display: true, text: "Months" } }
            },
            onClick: (evt, items) => {
                if(items.length > 0){
                    const idx = items[0].index;
                    const monthObj = monthsRange[idx]; // get month/year object

                    // Filter data for this month, including active group/location filters
                    const tableData = filteredData.filter(r => {
                        if(groupFilter && r.group !== groupFilter) return false;
                        if(locationFilter && r.location !== locationFilter) return false;

                        return getScheduled(r).some(s => s.date.getFullYear() === monthObj.year && s.date.getMonth() === monthObj.month);
                    });

                    // Open the modal table for this month
                    openModal(
                        `Scheduled PPM – ${MONTHS[monthObj.month].toUpperCase()} ${monthObj.year}` + 
                        (groupFilter ? ` | Group: ${groupFilter}` : "") + 
                        (locationFilter ? ` | Location: ${locationFilter}` : ""),
                        tableData
                    );
                }
            }
        }
    });
}
renderScheduledMonthChart();

// --- Scheduled PPM Chart Filters ---
const scheduledGroupSelect = document.getElementById("scheduledGroupFilter");
const scheduledLocationSelect = document.getElementById("scheduledLocationFilter");
const scheduledResetBtn = document.getElementById("scheduledResetBtn");

// Populate locations dynamically based on selected group
scheduledGroupSelect.addEventListener("change", () => {
    const group = scheduledGroupSelect.value;
    scheduledGroupFilter = group;

    // Filter locations for this group
    const locations = [...new Set(data.filter(r => !group || r.group === group).map(r => r.location))];

    scheduledLocationSelect.innerHTML = '<option value="">Select Location</option>';
    locations.forEach(loc => {
        const option = document.createElement("option");
        option.value = loc;
        option.textContent = loc;
        scheduledLocationSelect.appendChild(option);
    });

    scheduledLocationFilter = "";
    scheduledLocationSelect.value = "";
    renderScheduledMonthChart(data, scheduledGroupFilter, scheduledLocationFilter);
});

// Apply location filter
scheduledLocationSelect.addEventListener("change", () => {
    scheduledLocationFilter = scheduledLocationSelect.value;
    renderScheduledMonthChart(data, scheduledGroupFilter, scheduledLocationFilter);
});

// Reset button
scheduledResetBtn.addEventListener("click", () => {
    scheduledGroupFilter = "";
    scheduledLocationFilter = "";
    scheduledGroupSelect.value = "";
    scheduledLocationSelect.innerHTML = '<option value="">Select Location</option>';
    renderScheduledMonthChart();
});

document.getElementById("logoutBtn").addEventListener("click", function() {
    // Optional: Clear any session info if used
    // localStorage.removeItem("loggedInUser");

    // Redirect to welcome page
    window.location.href = "welcome.html"; // <-- replace with your actual welcome page filename
});

</script>

</body>
</html>
